#!/usr/bin/env node
var Cuker = require('../lib/cuker.js');
var minimist = require('minimist');
var freeport = require('freeport');

var argv = minimist(process.argv, {
  'default': {
    "browser": "phantomjs",
    "platform": "ANY",
    "name": "",
    "debug": false,
    "host": "localhost",
    "path": "features",
    "user": "",
    "key": "",
    "log": "silent",
    "timeoutsAsyncScript": 10000
  },
  'boolean': true
});

try {
  if (!argv.port) {
    freeport(function (error, port) {
      if (error) {
        throw error;
      }
      argv.port = port;
      startCuker(argv);
    });
  } else {
    startCuker(argv)
  }

} catch (ex) {
  process.stderr.write(ex.stack + '\n');
  process.exit(2);
}

function startCuker(options) {
  var cuker = new Cuker(options);
  cuker.start(function (err) {
    process.exit(err ? 2 : 0);
  });
}
