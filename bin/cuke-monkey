#!/usr/bin/env node
var Monkey    = require('../lib/monkey.js'),
    minimist = require('minimist'),
    freeport = require('freeport');

var argv = minimist(process.argv, {
  'default': {
    "browser": "phantomjs",
    "platform": "ANY",
    "name": "",
    "debug": false,
    "host": "localhost",
    "path": "features",
    "user": "",
    "key": "",
    "log": "silent",
    "timeoutsAsyncScript": 10000
  },
  'boolean': true
});

try {
  if (!argv.port) {
    freeport(function (error, port) {
      if (error) {
        throw error;
      }
      argv.port = port;
      startMonkey(argv);
    });
  } else {
    startMonkey(argv)
  }

} catch (ex) {
  process.stderr.write(ex.stack + '\n');
  process.exit(2);
}

function startMonkey (options) {
  var monkey = new Monkey(options);
  monkey.init(function (err) {
    process.exit(err ? 2 : 0);
  });
}
